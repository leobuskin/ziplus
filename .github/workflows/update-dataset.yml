name: Update dataset

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

concurrency:
  group: update-dataset
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v5
        with:
          python-version: '3.14'
          allow-prereleases: true
      - run: pip install -e .

      - name: Record current checksum
        run: python scripts/build_dataset.py --checksum > /tmp/old_checksum.txt

      - name: Download and rebuild
        run: python scripts/build_dataset.py --download

      - name: Record new checksum
        run: python scripts/build_dataset.py --checksum > /tmp/new_checksum.txt

      - name: Check for changes
        id: diff
        run: |
          if diff -q /tmp/old_checksum.txt /tmp/new_checksum.txt > /dev/null 2>&1; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Bump version and push
        if: steps.diff.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/version.txt data/US.txt ziplus/zipcodes.json.gz
          git commit -m "chore: update GeoNames dataset"
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v2.0.0")
          MAJOR=$(echo "$LATEST_TAG" | sed 's/v//' | cut -d. -f1)
          MINOR=$(echo "$LATEST_TAG" | sed 's/v//' | cut -d. -f2)
          PATCH=$(echo "$LATEST_TAG" | sed 's/v//' | cut -d. -f3)
          NEW_TAG="v${MAJOR}.${MINOR}.$((PATCH + 1))"
          git tag "$NEW_TAG"
          git push origin HEAD "$NEW_TAG"
